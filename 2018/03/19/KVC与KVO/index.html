<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="John Doe"><link rel="alternative" href="/atom.xml" title="I am cutier" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>KVC与KVO - I am cutier</title><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><script src="/js/jquery-3.1.1.min.js"></script><script src="/js/fancybox/jquery.fancybox.min.js"></script></head><body style="opacity:0"><header class="head"><h1 class="head-title u-fl"><a href="/">I am cutier</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/archives">カタログ/（目录）</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"> <time class="post__time" datetime="2018-03-19T05:48:29.000Z">March 19, 2018</time><h1 class="post__title"><a href="/2018/03/19/KVC与KVO/">KVC与KVO</a></h1><div class="post__main echo"><p>##KVC :Key-Value-Coding（键值编码）<br> 一个非正式的 Protocol，提供一种机制来间接访问对象的属性</p>
<p>下面是使用KVC 和 不使用 KVC的代码对比<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Persion *persion =  [ [Persion alloc] init ];</span><br><span class="line"><span class="comment">//不使用KVC</span></span><br><span class="line">persion.name = <span class="string">@"hufeng"</span> ;</span><br><span class="line"> <span class="comment">//使用KVC的写法</span></span><br><span class="line">[persion  setValue:<span class="string">@"hufeng"</span> forKey:<span class="string">@"name"</span>];</span><br></pre></td></tr></table></figure></p>
<p>复杂点的：我们有一个人,这个人有一个手机类,这个手机类有一个电池类 我们要获取这个电池类<br>不用KVC：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Person *persion =  [ [Person alloc] init ];</span><br><span class="line">Phone *phone = person.phone;</span><br><span class="line">Battery *battery = phone.battery;</span><br></pre></td></tr></table></figure></p>
<p>使用KVC<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Battery *battery = [person valueForKeyPath: <span class="string">@"phone.battery"</span>];</span><br><span class="line"><span class="comment">//相当于</span></span><br><span class="line">[[person valueForKey: <span class="string">@"phone"</span>] valueForKey:<span class="string">@"battery"</span>];</span><br></pre></td></tr></table></figure></p>
<p>KVC可以被用到字典转模型中<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)initWithKVCDictionary:(<span class="built_in">NSDictionary</span> *)KVCDic&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line"></span><br><span class="line">        [<span class="keyword">self</span> setValuesForKeysWithDictionary:KVCDic];</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果key不存在会崩溃，加以下代码解决：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">id</span>)value forUndefinedKey:(<span class="built_in">NSString</span> *)key&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"key = %@"</span>,key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果key为id，可以这样处理：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">id</span>)value forUndefinedKey:(<span class="keyword">nonnull</span> <span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span> ([key isEqualToString:<span class="string">@"id"</span>]) &#123;</span><br><span class="line">        <span class="keyword">self</span>.appId = (<span class="keyword">int</span>)value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>##KVO :Key-Value-Observing（键值观察）<br> 提供了一种当其它对象属性被修改的时候能通知当前对象的机制。</p>
<p>KVO使用分三步：</p>
<pre><code>(1)注册成为观察者

(2)观察者定义KVO的回调

(3)移除观察者
</code></pre><p>参考网上一篇文章:</p>
<p>######1.假设一个场景,股票的价格显示在当前屏幕上，当股票价格更改的时候，实时显示更新其价格<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">StockData</span> : <span class="title">NSObject</span> </span>&#123;  </span><br><span class="line">    <span class="built_in">NSString</span> * stockName;  </span><br><span class="line">    <span class="keyword">float</span> price;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">@end</span>  </span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">StockData</span>  </span></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<p>######2.定义此model为Controller的属性，实例化它，监听它的属性，并显示在当前的View里边<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad  </span><br><span class="line">&#123;  </span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];  </span><br><span class="line"></span><br><span class="line">    stockForKVO = [[StockData alloc] init];  </span><br><span class="line">    [stockForKVO setValue:<span class="string">@"10.0"</span> forKey:<span class="string">@"price"</span>];      </span><br><span class="line">    [stockForKVO addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@"price"</span> options:<span class="built_in">NSKeyValueObservingOptionNew</span>|<span class="built_in">NSKeyValueObservingOptionOld</span> context:<span class="literal">NULL</span>];  </span><br><span class="line"></span><br><span class="line">    myLabel = [[<span class="built_in">UILabel</span> alloc]initWithFrame:<span class="built_in">CGRectMake</span>(<span class="number">100</span>, <span class="number">100</span>, <span class="number">100</span>, <span class="number">30</span> )];  </span><br><span class="line">    myLabel.textColor = [<span class="built_in">UIColor</span> redColor];  </span><br><span class="line">    myLabel.text = [stockForKVO valueForKey:<span class="string">@"price"</span>];  </span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:myLabel];  </span><br><span class="line"></span><br><span class="line">    <span class="built_in">UIButton</span> * b = [<span class="built_in">UIButton</span> buttonWithType:<span class="built_in">UIButtonTypeRoundedRect</span>];  </span><br><span class="line">    b.frame = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">30</span>);  </span><br><span class="line">    [b addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(buttonAction) forControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>];  </span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:b];  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>######3.当点击button的时候，调用buttonAction方法，修改对象的属性<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-(<span class="keyword">void</span>) buttonAction  </span><br><span class="line">&#123;  </span><br><span class="line">    [stockForKVO setValue:<span class="string">@"20.0"</span> forKey:<span class="string">@"price"</span>];  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>######4. 实现回调方法<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-(<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">id</span>)object change:(<span class="built_in">NSDictionary</span> *)change context:(<span class="keyword">void</span> *)context  </span><br><span class="line">&#123;  </span><br><span class="line">    <span class="keyword">if</span>([keyPath isEqualToString:<span class="string">@"price"</span>])  </span><br><span class="line">    &#123;  </span><br><span class="line">        myLabel.text = [stockForKVO valueForKey:<span class="string">@"price"</span>];  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>######5.增加观察与取消观察是成对出现的，所以需要在最后的时候，移除观察者<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)dealloc  </span><br><span class="line">&#123;  </span><br><span class="line">    [<span class="keyword">super</span> dealloc];  </span><br><span class="line">    [stockForKVO removeObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@"price"</span>];  </span><br><span class="line">    [stockForKVO release];  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</div></header><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a class="post__tag__link" href="/tags/KVC-KVO/">KVC KVO</a></li></ul></footer></article><div class="comments" id="lv-container" data-id="city" data-uid="your uid"><script>(function(d, s) {var j, e = d.getElementsByTagName(s)[0];if (typeof LivereTower === 'function') { return; } j = d.createElement(s);j.src = 'https://cdn-city.livere.com/js/embed.dist.js';j.async = true;e.parentNode.insertBefore(j, e);})(document, 'script');</script></div></main><footer class="foot"><div class="foot-copy">&copy; 2016-2018 John Doe</div></footer><script src="/js/scroller.js"></script><script src="/js/main.js"></script></body></html>