<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="John Doe"><link rel="alternative" href="/atom.xml" title="Hexo" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>oc与js交互之WKWebView - Hexo</title><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><script src="/js/jquery-3.1.1.min.js"></script><script src="/js/fancybox/jquery.fancybox.min.js"></script></head><body style="opacity:0"><header class="head"><h1 class="head-title u-fl"><a href="/">Hexo</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/archives">カタログ/（目录）</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"> <time class="post__time" datetime="2018-03-19T05:53:16.000Z">March 19, 2018</time><h1 class="post__title"><a href="/2018/03/19/oc与js交互之WKWebView/">oc与js交互之WKWebView</a></h1><div class="post__main echo"><blockquote>
<p>WKWebView是苹果在 iOS 8 中引入的新组件，目的是给出一个新的高性能的 Web View 解决方案，摆脱过去 UIWebView 的老旧笨重特别是内存占用量巨大的问题，它使用Nitro JavaScript引擎，这意味着所有第三方浏览器运行JavaScript将会跟safari一样快.</p>
</blockquote>
<p>#####导入头文件<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;WebKit/WebKit.h&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<h5 id="配置webView加载页面"><a href="#配置webView加载页面" class="headerlink" title="配置webView加载页面"></a>配置webView加载页面</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">WKWebViewConfiguration</span> *config = [[<span class="built_in">WKWebViewConfiguration</span> alloc] init];</span><br><span class="line">config.userContentController = [[<span class="built_in">WKUserContentController</span> alloc] init];</span><br><span class="line"><span class="comment">//注册js方法</span></span><br><span class="line">[config.userContentController addScriptMessageHandler:<span class="keyword">self</span> name:<span class="string">@"myWebView"</span>];</span><br><span class="line">_webView = [[<span class="built_in">WKWebView</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="keyword">self</span>.view.bounds.size.width, <span class="keyword">self</span>.view.bounds.size.height - <span class="number">80</span>) configuration:config];</span><br><span class="line">[<span class="keyword">self</span>.webView loadRequest:[<span class="built_in">NSURLRequest</span> requestWithURL:[<span class="built_in">NSURL</span> URLWithString:<span class="string">@"http://192.168.0.114:8020/AppTest/index.html"</span>]]];</span><br><span class="line"><span class="keyword">self</span>.webView.navigationDelegate = <span class="keyword">self</span>;</span><br><span class="line"><span class="keyword">self</span>.webView.UIDelegate = <span class="keyword">self</span>;</span><br><span class="line">[<span class="keyword">self</span>.view addSubview:<span class="keyword">self</span>.webView];</span><br></pre></td></tr></table></figure>
<h5 id="遵守的代理方法有："><a href="#遵守的代理方法有：" class="headerlink" title="遵守的代理方法有："></a>遵守的代理方法有：</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">WKNavigationDelegate</span>, <span class="built_in">WKUIDelegate</span>, <span class="built_in">WKScriptMessageHandler</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>WKNavigationDelegate   (webview.navigationDelegate = self)</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 页面开始加载时调用</span></span><br><span class="line">- (<span class="keyword">void</span>)webView:(<span class="built_in">WKWebView</span> *)webView didStartProvisionalNavigation:(<span class="built_in">WKNavigation</span> *)navigation &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"didStartProvisionalNavigation"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 已开始加载页面，可以在这一步向view中添加一个过渡动画</span></span><br><span class="line">- (<span class="keyword">void</span>)webView:(<span class="built_in">WKWebView</span> *)webView didCommitNavigation:(<span class="built_in">WKNavigation</span> *)navigation &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 页面已全部加载，可以在这一步把过渡动画去掉</span></span><br><span class="line">- (<span class="keyword">void</span>)webView:(<span class="built_in">WKWebView</span> *)webView didFinishNavigation:(<span class="built_in">WKNavigation</span> *)navigation &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 页面加载失败时调用</span></span><br><span class="line">- (<span class="keyword">void</span>)webView:(<span class="built_in">WKWebView</span> *)webView didFailProvisionalNavigation:(<span class="built_in">WKNavigation</span> *)navigation &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>WKUIDelegate (self.webView.UIDelegate = self;)</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  web界面中有弹出警告框时调用（js中alert的拦截）</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  @param webView           实现该代理的webview</span></span><br><span class="line"><span class="comment"> *  @param message           警告框中的内容</span></span><br><span class="line"><span class="comment"> *  @param frame             主窗口</span></span><br><span class="line"><span class="comment"> *  @param completionHandler 警告框消失调用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)webView:(<span class="built_in">WKWebView</span> *)webView runJavaScriptAlertPanelWithMessage:(<span class="built_in">NSString</span> *)message initiatedByFrame:(<span class="keyword">nonnull</span> <span class="built_in">WKFrameInfo</span> *)frame completionHandler:(<span class="keyword">nonnull</span> <span class="keyword">void</span> (^)(<span class="keyword">void</span>))completionHandler &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, message);<span class="comment">//哈哈，我是alert</span></span><br><span class="line">   <span class="comment">//显示弹出框代码略，弹出框消失时需要回调completionHandler，否则会crash</span></span><br><span class="line">    completionHandler();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>对应js的代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">  	alert(&quot;哈哈，我是alert&quot;);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>WKScriptMessageHandler ([config.userContentController addScriptMessageHandler:])<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//初始化配置时注册js方法，当js调用oc代码时（如上面的myWebView），会回调此方法</span></span><br><span class="line">- (<span class="keyword">void</span>)userContentController:(<span class="built_in">WKUserContentController</span> *)userContentController didReceiveScriptMessage:(<span class="built_in">WKScriptMessage</span> *)message &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"WKScriptMessage == %@"</span>, message.name);<span class="comment">//myWebView</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>对应js代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">  	window.webkit.messageHandlers.webViewApp.postMessage(null);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure></p>
<p>#####oc调js方法</p>
<blockquote>
<p>evaluateJavaScript方法，如果有参数格式是getAA(参数，参数…）<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">self</span>.webView evaluateJavaScript:<span class="string">@"getAA()"</span> completionHandler:^(<span class="keyword">id</span> _Nullable info, <span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, info);<span class="comment">//返回值</span></span><br><span class="line">    &#125;];</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>#####js调oc方法</p>
<blockquote>
<p>好像上面已经说过了，再说一遍。。</p>
<ul>
<li>注册js方法<br>  [config.userContentController addScriptMessageHandler:self name:@”js方法”];</li>
<li>处理handler委托<br>-(void)userContentController:(WKUserContentController <em>)userContentController didReceiveScriptMessage:(WKScriptMessage </em>)message;</li>
</ul>
</blockquote>
<p>#####其他<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//返回</span></span><br><span class="line">[<span class="keyword">self</span>.webView goBack];</span><br><span class="line"><span class="comment">//前进</span></span><br><span class="line">[<span class="keyword">self</span>.webView goForward];</span><br><span class="line"></span><br><span class="line">[<span class="keyword">self</span>.webView addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@"loading"</span> options:(<span class="built_in">NSKeyValueObservingOptionNew</span>) context:<span class="literal">nil</span>];</span><br><span class="line"><span class="comment">//监听加载进度</span></span><br><span class="line">[<span class="keyword">self</span>.webView addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@"estimatedProgress"</span> options:<span class="built_in">NSKeyValueObservingOptionNew</span> context:<span class="literal">nil</span>];</span><br></pre></td></tr></table></figure></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">id</span>)object change:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSKeyValueChangeKey</span>,<span class="keyword">id</span>&gt; *)change context:(<span class="keyword">void</span> *)context &#123;</span><br><span class="line">    <span class="keyword">if</span> ([keyPath isEqualToString:<span class="string">@"loading"</span>]) &#123;</span><br><span class="line"><span class="comment">//        gobackBtn.enabled = self.webView.canGoBack;</span></span><br><span class="line"><span class="comment">//        forwardBtn.enabled = self.webView.canGoForward;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ([keyPath isEqualToString:<span class="string">@"estimatedProgress"</span>]) &#123;</span><br><span class="line">        <span class="comment">//progress是UIProgressView</span></span><br><span class="line">        progress.hidden = <span class="keyword">self</span>.webView.estimatedProgress==<span class="number">1</span>;</span><br><span class="line">        [progress setProgress:<span class="keyword">self</span>.webView.estimatedProgress animated:<span class="literal">YES</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参考链接<br><a href="http://liuyanwei.jumppo.com/2015/10/17/ios-webView.html" target="_blank" rel="noopener">http://liuyanwei.jumppo.com/2015/10/17/ios-webView.html</a></p>
</div></header></article><div class="comments" id="lv-container" data-id="city" data-uid="your uid"><script>(function(d, s) {var j, e = d.getElementsByTagName(s)[0];if (typeof LivereTower === 'function') { return; } j = d.createElement(s);j.src = 'https://cdn-city.livere.com/js/embed.dist.js';j.async = true;e.parentNode.insertBefore(j, e);})(document, 'script');</script></div></main><footer class="foot"><div class="foot-copy">&copy; 2016-2018 John Doe</div></footer><script src="/js/scroller.js"></script><script src="/js/main.js"></script></body></html>